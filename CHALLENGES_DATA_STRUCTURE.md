# Challenges Data Structure

## Overview
The application supports both:
1. **Daily Questions** - Tap-to-reveal format (existing system)
2. **Challenges** - Multiple choice quiz format (new system)

Both systems coexist and users can access both.

## Firebase Collections

### `questions` Collection (Daily Questions)

Stores daily questions in tap-to-reveal format (existing system).

```json
{
  "date": "2026-01-11",
  "question": "Kerala was formed as a state in which year?",
  "answer": "1956"
}
```

### `challenges` Collection

Each challenge document contains multiple choice questions:

```json
{
  "challengeId": "auto-generated-id",
  "title": "Kerala History Basics",
  "description": "Test your knowledge of Kerala history",
  "questions": [
    {
      "questionId": "q001",
      "question": "Kerala was formed as a state in which year?",
      "options": ["1950", "1956", "1960", "1947"],
      "correctAnswer": 1,
      "explanation": "Kerala was formed on November 1, 1956"
    },
    {
      "questionId": "q002",
      "question": "Longest river in Kerala?",
      "options": ["Bharathapuzha", "Periyar", "Pamba", "Chalakudy"],
      "correctAnswer": 1,
      "explanation": "Periyar is the longest river in Kerala"
    }
  ],
  "createdAt": "server_timestamp",
  "difficulty": "beginner",
  "estimatedTime": 10
}
```

**Field Descriptions:**
- `challengeId` (string, auto-generated): Unique identifier for the challenge (automatically generated by Firebase and set to match the document ID)
- `title` (string, required): Challenge title
- `description` (string, optional): Challenge description
- `questions` (array, required): Array of multiple choice question objects
  - `questionId` (string, required): Unique identifier for the question
  - `question` (string, required): Question text
  - `options` (array, required): Array of 4 answer options (strings)
  - `correctAnswer` (number, required): Index of correct answer (0-3)
  - `explanation` (string, optional): Explanation for the answer
- `createdAt` (timestamp, required): When the challenge was created
- `difficulty` (string, optional): "beginner", "intermediate", "advanced"
- `estimatedTime` (number, optional): Estimated completion time in minutes

### `userChallenges` Collection

Tracks user progress for challenges:

```json
{
  "userId": "firebase_uid",
  "email": "user@example.com",
  "completedChallengeIds": ["challenge_001", "challenge_002"],
  "completedCount": 2,
  "createdAt": "server_timestamp",
  "lastUpdated": "server_timestamp"
}
```

**Field Descriptions:**
- `userId` (string, required): Firebase Auth UID
- `email` (string, required): User email
- `completedChallengeIds` (array, required): Array of completed challenge IDs
- `completedCount` (number, required): Number of completed challenges
- `createdAt` (timestamp, required): Document creation time
- `lastUpdated` (timestamp, required): Last update time

### `userCompletions` Collection (for Daily Questions)

Tracks user progress for daily questions (existing system):

```json
{
  "userId": "firebase_uid",
  "email": "user@example.com",
  "completedQuestionIds": ["question_id_1", "question_id_2"],
  "completedCount": 5,
  "createdAt": "server_timestamp",
  "lastUpdated": "server_timestamp"
}
```

## Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Questions collection - read for authenticated users
    match /questions/{document=**} {
      allow read: if request.auth != null;
      allow create, update, delete: if false; // Admin only
    }
    
    // Challenges collection - read-only for authenticated users
    match /challenges/{challengeId} {
      allow read: if request.auth != null;
      allow create, update, delete: if false; // Admin only
    }
    
    // User challenges collection - user-specific read/write
    match /userChallenges/{userId} {
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }
    
    // User completions collection - user-specific read/write (for daily questions)
    match /userCompletions/{userId} {
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }
  }
}
```

### `factClusters` Collection

Stores fact clusters where multiple questions share the same answer (different_facts_same_answer type):

```json
{
  "clusterId": "cluster_kottayam_verified_025",
  "type": "different_facts_same_answer",
  "difficulty": "beginner",
  "answer": {
    "en": "Kottayam",
    "ml": "കോട്ടയം"
  },
  "facts": [
    {
      "factId": "f001",
      "question": {
        "en": "Which district in India was the first to achieve 100% literacy?",
        "ml": "ഇന്ത്യയിൽ ആദ്യമായി 100% സാക്ഷരത നേടിയ ജില്ല ഏത്?"
      }
    }
  ],
  "createdAt": "server_timestamp",
  "updatedAt": "server_timestamp"
}
```

**Field Descriptions:**
- `clusterId` (string, required): Unique identifier for the cluster (used as document ID)
- `type` (string, required): Must be "different_facts_same_answer"
- `difficulty` (string, optional): "beginner", "intermediate", "advanced"
- `answer` (object, required): Answer object with multilingual support
  - `en` (string, required): Answer in English
  - `ml` (string, optional): Answer in Malayalam
- `facts` (array, required): Array of fact/question objects
  - `factId` (string, required): Unique identifier for the fact
  - `question` (object, required): Question text with multilingual support
    - `en` (string, required): Question in English
    - `ml` (string, optional): Question in Malayalam

## Query Patterns

### Fetch All Challenges
```javascript
const challengesRef = firebase.firestore().collection('challenges');
const snapshot = await challengesRef.get();
```

### Fetch All Fact Clusters
```javascript
const clustersRef = firebase.firestore().collection('factClusters');
const snapshot = await clustersRef.get();
```

### Fetch Available Challenges (Not Completed)
```javascript
const userDoc = await firebase.firestore()
  .collection('userChallenges')
  .doc(userId)
  .get();
const completedIds = userDoc.data()?.completedChallengeIds || [];
const availableChallenges = challenges.filter(
  c => !completedIds.includes(c.id)
);
```

### Mark Challenge as Complete
```javascript
const userRef = firebase.firestore()
  .collection('userChallenges')
  .doc(userId);
await userRef.update({
  completedChallengeIds: firebase.firestore.FieldValue.arrayUnion(challengeId),
  completedCount: firebase.firestore.FieldValue.increment(1),
  lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
});
```
